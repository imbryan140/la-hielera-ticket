<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | La Hielera Business</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f0f0f; color: #ffffff; }
        .matte-card { background-color: #1a1a1a; border: 1px solid #333; }
    </style>
</head>
<body class="p-4 md:p-10 font-sans">
    
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-black uppercase tracking-tighter italic text-white">Panel de Control</h1>
                <p id="db-status" class="text-orange-500 font-bold uppercase text-xs tracking-[0.3em]">Cargando base de datos... üßä</p>
            </div>
            <img src="logo.png" alt="Logo" class="h-16">
        </div>

        <div class="matte-card rounded-[2rem] overflow-hidden shadow-2xl">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-[#222] text-gray-500 text-[10px] uppercase tracking-widest border-b border-gray-800">
                            <th class="p-5">ID Ticket</th>
                            <th class="p-5">Ganador</th>
                            <th class="p-5">WhatsApp</th>
                            <th class="p-5">Premio</th>
                            <th class="p-5">Estado</th>
                            <th class="p-5 text-right">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-ganadores" class="divide-y divide-gray-800 text-sm">
                        <tr><td colspan="6" class="p-10 text-center text-gray-500 italic">Esperando datos de Firebase...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD6y3u_6pmJkYm0tb3awnhrmWsgJrouUOQ",
            authDomain: "la-hielera-ticket.firebaseapp.com",
            projectId: "la-hielera-ticket",
            storageBucket: "la-hielera-ticket.firebasestorage.app",
            messagingSenderId: "1027341293744",
            appId: "1:1027341293744:web:186bf82f009f9a7270c375"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Escuchamos la colecci√≥n "tickets"
        onSnapshot(collection(db, "tickets"), (snapshot) => {
            const list = document.getElementById('lista-ganadores');
            const statusLabel = document.getElementById('db-status');
            
            if (snapshot.empty) {
                statusLabel.innerText = "Base de datos vac√≠a ‚ö†Ô∏è";
                list.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-orange-500">No se encontraron tickets en la colecci√≥n "tickets".</td></tr>';
                return;
            }

            statusLabel.innerText = `Conexi√≥n OK: ${snapshot.size} tickets detectados üßä`;
            list.innerHTML = "";
            
            let contadorFilas = 0;

            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                
                // IMPORTANTE: Mostramos el ticket si el status NO es "disponible"
                // He a√±adido .toLowerCase() para evitar errores de may√∫sculas
                if (data.status && data.status.toLowerCase() !== "disponible") {
                    contadorFilas++;
                    const esEntregado = data.status.toLowerCase() === 'entregado';
                    
                    list.innerHTML += `
                    <tr class="hover:bg-[#222] transition-colors">
                        <td class="p-5 font-mono text-orange-500 font-bold">#${docSnap.id}</td>
                        <td class="p-5">
                            <div class="font-bold text-white">${data.nombre || 'N/A'}</div>
                            <div class="text-[10px] text-gray-500">${data.fechaRegistro || ''}</div>
                        </td>
                        <td class="p-5 text-gray-300">
                            <a href="https://wa.me/${data.telefono}" target="_blank" class="hover:text-orange-500 underline decoration-gray-700">
                                ${data.telefono || 'Sin n√∫mero'}
                            </a>
                        </td>
                        <td class="p-5">
                            <span class="bg-[#262626] border border-gray-700 px-3 py-1 rounded-lg text-white text-xs font-medium uppercase">
                                ${data.premio || 'No asignado'}
                            </span>
                        </td>
                        <td class="p-5">
                            <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-tighter ${esEntregado ? 'bg-green-500/20 text-green-400' : 'bg-orange-500/20 text-orange-400'}">
                                ${data.status}
                            </span>
                        </td>
                        <td class="p-5 text-right">
                            ${!esEntregado ? `
                                <button onclick="marcarEntregado('${docSnap.id}')" 
                                    class="bg-white hover:bg-orange-500 hover:text-white text-black font-black px-4 py-2 rounded-xl text-[10px] transition duration-300 shadow-lg">
                                    MARCAR ENTREGADO
                                </button>
                            ` : `<span class="text-gray-600 text-xs italic font-bold">ENTREGADO ‚úì</span>`}
                        </td>
                    </tr>`;
                }
            });

            if (contadorFilas === 0) {
                list.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-500">Hay tickets, pero ninguno ha sido reclamado a√∫n.</td></tr>';
            }
        }, (error) => {
            console.error(error);
            statusLabel.innerText = "Error de permisos ‚ùå";
            list.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-red-500 font-bold">Error de lectura: Revisa las REGLAS de Firestore.</td></tr>`;
        });

        window.marcarEntregado = async (id) => {
            if(confirm(`¬øConfirmas la entrega del premio para el ticket #${id}?`)) {
                try {
                    await updateDoc(doc(db, "tickets", id), { status: "entregado" });
                } catch (e) {
                    alert("Error: No tienes permiso para actualizar.");
                }
            }
        };
    </script>
</body>
</html>
