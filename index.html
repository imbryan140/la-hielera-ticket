<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Hielera | Reclama tu Ticket</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('fondo.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
        }
        .matte-card {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Animación de entrada */
        .animate-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border-top-color: #f97316;
            animation: spinner 0.6s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6 text-white">

    <div id="app" class="matte-card p-8 rounded-[2.5rem] shadow-2xl max-w-md w-full text-center backdrop-blur-xl">
        <img src="logo.png" alt="La Hielera" class="w-28 mx-auto mb-6">
        
        <div id="loading" class="flex flex-col items-center gap-4">
            <div class="loader w-10 h-10 border-4 border-gray-700 rounded-full"></div>
            <p class="text-gray-400 text-sm font-bold uppercase tracking-widest">Validando Ticket...</p>
        </div>
        
        <div id="form-container" class="hidden animate-in">
            <h1 class="text-4xl font-black uppercase italic mb-2 tracking-tighter">¡Felicidades!</h1>
            <p class="text-gray-400 mb-6 text-xs uppercase tracking-[0.2em] font-bold">
                Ticket <span id="ticket-id" class="text-orange-500"></span> Detectado
            </p>
            
            <div class="bg-orange-500/10 p-6 rounded-2xl mb-8 border border-orange-500/20 relative overflow-hidden">
                <i class="fa-solid fa-gift absolute -right-4 -bottom-4 text-6xl text-orange-500/10 rotate-12"></i>
                <p class="text-[10px] text-orange-500 uppercase font-black mb-1 tracking-widest">Tu premio exclusivo:</p>
                <h2 class="text-2xl font-black text-white uppercase tracking-tight" id="premio-text"></h2>
            </div>
            
            <div class="space-y-4 text-left">
                <div class="relative">
                    <label class="text-[10px] uppercase text-gray-500 font-bold ml-2 tracking-widest">Nombre Completo</label>
                    <div class="relative flex items-center mt-1">
                        <i class="fa-solid fa-user absolute left-4 text-gray-500"></i>
                        <input type="text" id="nombre" placeholder="¿A quién registramos?" 
                            class="w-full bg-[#222] border-none p-4 pl-12 rounded-xl text-white placeholder-gray-600 focus:ring-2 focus:ring-orange-500 outline-none transition">
                    </div>
                </div>
                
                <div class="relative">
                    <label class="text-[10px] uppercase text-gray-500 font-bold ml-2 tracking-widest">WhatsApp</label>
                    <div class="relative flex items-center mt-1">
                        <i class="fa-brands fa-whatsapp absolute left-4 text-green-500 text-lg"></i>
                        <input type="tel" id="telefono" placeholder="Ej: 04121234567" 
                            class="w-full bg-[#222] border-none p-4 pl-12 rounded-xl text-white placeholder-gray-600 focus:ring-2 focus:ring-orange-500 outline-none transition">
                    </div>
                </div>
                
                <div class="flex items-start text-[11px] text-gray-400 text-left px-1 py-2">
                    <input type="checkbox" id="tos" class="mt-0.5 mr-3 h-4 w-4 rounded accent-orange-500 cursor-pointer"> 
                    <label for="tos" class="cursor-pointer leading-tight">
                        Confirmo que tengo el ticket físico y acepto los 
                        <button type="button" onclick="mostrarTOS()" class="text-orange-500 font-bold underline">Términos del Club</button>
                    </label>
                </div>

                <button onclick="registrarTicket()" id="btn-claim"
                    class="w-full bg-orange-500 hover:bg-orange-600 text-black font-black py-5 rounded-2xl transition duration-300 transform active:scale-95 shadow-xl shadow-orange-500/20 uppercase tracking-widest text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trophy"></i> RECLAMAR MI PREMIO
                </button>
            </div>
        </div>

        <div id="error-message" class="hidden animate-in">
            <div class="text-orange-500 text-5xl mb-4"><i class="fa-solid fa-circle-exclamation"></i></div>
            <div id="error-text" class="text-orange-400 font-bold p-6 border border-orange-500/20 rounded-2xl bg-orange-500/5 uppercase text-xs tracking-widest"></div>
            <button onclick="location.reload()" class="mt-6 text-gray-500 text-[10px] font-bold uppercase tracking-[0.3em] hover:text-white transition">Reintentar Escaneo</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD6y3u_6pmJkYm0tb3awnhrmWsgJrouUOQ",
            authDomain: "la-hielera-ticket.firebaseapp.com",
            projectId: "la-hielera-ticket",
            storageBucket: "la-hielera-ticket.firebasestorage.app",
            messagingSenderId: "1027341293744",
            appId: "1:1027341293744:web:186bf82f009f9a7270c375"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const ticketId = urlParams.get('id');

        window.mostrarTOS = () => {
            alert(`REGLAMENTO LA HIELERA:\n\n` +
            `• El ticket físico es indispensable para el canje.\n` +
            `• Los datos deben ser reales o el premio será anulado.\n` +
            `• Tienes 48 horas para reclamar el premio en tienda.\n` +
            `• Un ticket solo puede ser registrado una vez.`);
        };

        async function init() {
            if (!ticketId) {
                showError("QR NO VÁLIDO. Por favor, escanea un código oficial.");
                return;
            }
            try {
                const docRef = doc(db, "tickets", ticketId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().status === "disponible") {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('form-container').classList.remove('hidden');
                    document.getElementById('ticket-id').innerText = "#" + ticketId;
                    document.getElementById('premio-text').innerText = docSnap.data().premio;
                } else {
                    showError("TICKET AGOTADO. Este código ya fue reclamado.");
                }
            } catch (e) {
                showError("FALLO DE CONEXIÓN. Verifica tu internet.");
            }
        }

        window.registrarTicket = async () => {
            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const tos = document.getElementById('tos').checked;
            const btn = document.getElementById('btn-claim');

            if (!nombre || !telefono || !tos) {
                alert("Completa todos los datos y acepta los términos.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> PROCESANDO...`;

            try {
                const docRef = doc(db, "tickets", ticketId);
                await updateDoc(docRef, {
                    nombre: nombre,
                    telefono: telefono,
                    status: "reclamado",
                    fechaRegistro: new Date().toLocaleString()
                });
                alert("¡ÉXITO! Tu premio ha sido reservado. Muestra esta pantalla en caja junto con tu ticket físico.");
                location.reload();
            } catch (e) {
                alert("Error al registrar. Intenta de nuevo.");
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-trophy"></i> RECLAMAR MI PREMIO`;
            }
        };

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-text').innerText = msg;
            document.getElementById('error-message').classList.remove('hidden');
        }

        init();
    </script>
</body>
</html>
